<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Weighing System 2.0</title>
		<link rel="icon" href="images/favicon.ico" type="image/x-icon"/>
		<link rel="stylesheet" href="css/bootstrap.css" />		
		<link rel="stylesheet" href="css/bootstrap-dialog.css" />	
		<link rel="stylesheet" href="css/bootstrap-activate.css" />
		<link rel="stylesheet" href="css/font-awesome.min.css" />
		<link rel="stylesheet" href="css/stic-custom.css" />	
	</head>
	<body class="login-page">
		<div class="container">		
			<div class="row" id="pwd-container">
				<div class="col-md-8 col-centered">
					<section class="login-form" role="login">							
						<img src="images/vendor-logo.png" class="img-responsive" alt="" />			
						<hr>
						<div class="panel panel-primary no-margin-bottom">
							<div class="panel-heading">
								<i class="fa fa-desktop"></i> System Activation
							</div>
							<div class="panel-body">
								<div class="navbar" style="margin-bottom: 0px;">
									<div class="navbar-inner">
										<ul class="nav nav-pills nav-justified" id="nav-client">
											<li class="active"><a href="#step1" data-toggle_="tab" data-step="1">1. <i class="fa fa-file-text"></i> License File Upload</a></li>
											<li><a href="#step2" data-toggle_="tab" data-step="2">2. <i class="fa fa-info-circle"></i> Confirm License Details</a></li>
											<li><a href="#step3" data-toggle_="tab" data-step="3">3. <i class="fa fa-desktop"></i> Activation Status</a></li>
										</ul>
									</div>
								</div>	
								<hr style="margin-top: 5px; margin-bottom: 15px;">
								<div class="tab-content" id="tab-client">
									<div class="tab-pane fade in active" id="step1">
										<form class="form-horizontal well no-margin-bottom" id="formUploadFile" enctype="multipart/form-data">
											<div class="alert alert-info" role="alert" style="text-align: left; margin-bottom: 20px;">
												<i class="fa fa-info-circle fa-3x fa-pull-left"></i> Upload the license file provided by ScaleTech to start the system activation. After uploading the file, please confirm the license details before activating the system.
											</div>
											<div class="form-group" style="margin: 0px;">
												<input type="file" class="form-control input-sm filestyle" id="license_file" 
													data-size="nr"
													data-buttonBefore="true"
													data-buttonText="Find License File"
													data-buttonName="btn-primary"
													data-iconName="fa fa-folder-open"
													data-placeholder="No file">
											</div>
										</form>
										<hr style="margin-top: 15px; margin-bottom: 15px;">
										<div class="btn-toolbar" role="toolbar" aria-label="Toolbar with button groups" style="margin-bottom: 5px;">	
											<div class="btn-group pull-right" role="group" style="margin-bottom: 0px;">
												<button type="button" class="btn btn-primary" id="upload-license-file">
													<i class="fa fa-upload"></i> Upload License File
												</button>
											</div>
										</div>
									</div>
									<div class="tab-pane fade" id="step2">
										<div class=" well no-margin-bottom" style="padding: 15px">
											<div class="alert alert-info" role="alert" style="text-align: left; margin-bottom: 20px;">
												<i class="fa fa-info-circle fa-3x fa-pull-left"></i> Listed below are the license details from the license file you have uploaded. Please confirm the following details then proceed with the system activation.
											</div>											
											<table id="confirm-info" class="table table-bordered table-striped no-margin-bottom" style="clear: both;">
												<tbody>
													<tr>
														<td width="30%" class="make-bold">License Key</td>
														<td width="70%" data-cell="license_key"></td>														
													</tr>
													<tr>
														<td class="make-bold">License Duration</td>
														<td data-cell="license_duration"></td>														
													</tr>
													<tr>
														<td class="make-bold">Activation Date</td>
														<td data-cell="activation_date"></td>														
													</tr>
													<tr>
														<td class="make-bold">Expiration Date</td>
														<td data-cell="exp_date"></td>														
													</tr>					
												</tbody>
												<input type="hidden" data-field="cl_id">
												<input type="hidden" data-field="license_key">
												<input type="hidden" data-field="client_name">
												<input type="hidden" data-field="license_duration">
												<input type="hidden" data-field="license_status">
												<input type="hidden" data-field="activation_date">
												<input type="hidden" data-field="exp_date">
											</table>
										</div>
										<hr style="margin-top: 15px; margin-bottom: 15px;">
										<div class="btn-toolbar" role="toolbar" aria-label="Toolbar with button groups" style="margin-bottom: 5px;">	
											<div class="btn-group pull-right" role="group" style="margin-bottom: 0px;">
												<button type="button" class="btn btn-primary" id="confirm-activate">
													<i class="fa fa-check"></i> Confirm Activation
												</button>
											</div>
										</div>
									</div>
									<div class="tab-pane fade" id="step3">
										<div class=" well no-margin-bottom" style="padding: 15px">
											<div class="alert alert-success" role="alert" style="text-align: left; margin-bottom: 20px;">
												<i class="fa fa-check-circle fa-3x fa-pull-left"></i> <strong>Congratulations!</strong> You have successfully activated the system. You may now get started by logging on the system. Please refer below for the new license details.
											</div>
											<table id="success-info" class="table table-bordered table-striped no-margin-bottom" style="clear: both;">
												<tbody>
													<tr>
														<td width="30%" class="make-bold">License Key</td>
														<td width="70%" data-cell="license_key"></td>
													</tr>
													<tr>
														<td class="make-bold">License Duration</td>
														<td data-cell="license_duration"></td>
													</tr>
													<tr>
														<td class="make-bold">Activation Date</td>
														<td data-cell="activation_date"></td>
													</tr>
													<tr>
														<td class="make-bold">Expiration Date</td>
														<td data-cell="exp_date"></td>
													</tr>			
												</tbody>
											</table>											
										</div>
										<hr style="margin-top: 15px; margin-bottom: 15px;">
										<div class="btn-toolbar" role="toolbar" aria-label="Toolbar with button groups" style="margin-bottom: 5px;">	
											<div class="btn-group pull-right" role="group" style="margin-bottom: 0px;">
												<button type="button" class="btn btn-primary" id="get-started">
													<i class="fa fa-sign-in"></i> Go to Login Page
												</button>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
						<hr>
						<div class="login-footer">
							<div style="font-weight: bold">Scaletech International Corporation</div>
							<div>3050 F. Bautista St. Bo. Ugong, Valenzuela City</div>
							<div>Phone: 983-7895/96, Fax: 444-0592</div>
							<div>Email: scaletech_intl_corp@lycos.com</div>
						</div>
					</section>  
				</div>
			</div>
		</div>
		<script type="text/javascript" src="js/jquery.min.js"></script>
		<script type="text/javascript" src="js/jquery-widget.min.js"></script>
		<script type="text/javascript" src="js/bootstrap.min.js"></script>
		<script type="text/javascript" src="js/bootstrap-dialog.min.js"></script>
		<script type="text/javascript" src="js/bootstrap-filestyle.min.js"></script>		
		<script type="text/javascript" src="js/stic-constants.js"></script>
		<script type="text/javascript" src="js/stic-functions.js"></script>
		<script type="text/javascript">
			$(function () { 			
				// Check if already activated
				STIC.User.CheckIfActivated();
				
				// Initialize File Input
				$('#license_file').filestyle();
				$('#license_file').filestyle('clear');
			
				// Upload License File
				$('#upload-license-file').on('click', function () {
					var formData = new FormData(),
						fileData = $('input[type=file]')[0].files[0],
						pattern = new RegExp(/^([a-z]+)(\-)([\d]{14})\.(lcns)$/g);
					
					// Check License File Name
					if (pattern.test($('input[type=file]').val()) === false) {
						BootstrapDialog.alert({
							type: 'type-danger',
							title: MSG_TITLE_INFO,
							message: MSG_INFO_INVALID_FILE_FORMAT,
							callback: function (result) {
								BootstrapDialog.closeAll();
								window.location = DEFAULT_ROOT + 'activation.html';
							}
						});
						return false;
					}
					
					if (typeof fileData !== 'undefined') {
						formData.append('file', fileData);
					
						$.ajax({	
							type: 'POST',
							data: formData,
							processData: false,  
							contentType: false,
							url: WS_LICENSE_UPLOAD						
						})
						.done(function (data) {						
							try {
								var jsonString = $(data).find('div[name="passValue"]').text(),
								jsonObject = $.parseJSON(jsonString);
								$.each(jsonObject, function (name, value) {
									if (name === 'license_status') {
										$('#confirm-info td[data-cell="' + name + '"]').text(value === '0' ? 'Inactive' : 'Active');
									} else {
										$('#confirm-info td[data-cell="' + name + '"]').text(value);
									}
									$('#confirm-info input[data-field="' + name + '"]').val(value);
								});
															
								$('#step1').removeClass('in');
								$('#step1').removeClass('active');
								$('a[href="#step1"]').parent().removeClass('active');
								
								$('#step2').addClass('in');				
								$('#step2').addClass('active');
								$('a[href="#step2"]').parent().addClass('active');
							} catch (error) {
								BootstrapDialog.alert({
									type: 'type-danger',
									title: MSG_TITLE_INFO,
									message: MSG_INFO_INVALID_LICENSE_FILE,
									callback: function (result) {
										BootstrapDialog.closeAll();
										window.location = DEFAULT_ROOT + 'activation.html';
									}
								});
							}					
						})
						.fail(function () {
							BootstrapDialog.alert({
								type: 'type-danger',
								title: MSG_TITLE_INFO,
								message: MSG_INFO_WS_ERROR,
								callback: function (result) {
									BootstrapDialog.closeAll();
								}
							});
						});
						
					} else {
						BootstrapDialog.alert({
							type: 'type-danger',
							title: MSG_TITLE_INFO,
							message: MSG_INFO_INVALID_FILE_FORMAT,
							callback: function (result) {
								BootstrapDialog.closeAll();
							}
						});
					}

					return false;
				});
				
				// Confirm Activation
				$('#confirm-activate').on('click', function () {	
					var postString = '', 
						JSONString = '', JSONObject = {}, 
						elements = $('#confirm-info').find('input[data-field]');
					
					// Build post data
					$.each(elements, function (idx, elem) {
						var input = $(elem),
						inputValue = input.val(),
						inputField = input.attr('data-field');
						
						postString = '{"' + inputField + '":"' + inputValue + '"}';
						$.extend(JSONObject, $.parseJSON(postString));
					});
					
					// Build JSON string
					JSONString = 'licenseInfo=' + JSON.stringify(JSONObject);
					
					// Validate License Key
					$.post(WS_VALIDATE_LICENSE, JSONString)
						.done(function (results, status) {
						
							// on Success Update Client company table
							if (results.response.type === 'SUCCESS') {
								var params = {
									id: 1,
									is_license: 1,
									exp_date: $('input[data-field="exp_date"]').val(),		
									license_key: $('input[data-field="license_key"]').val(),																		
									duration: $('input[data-field="license_duration"]').val()									
								};
								
								// Update Client company table
								$.post(WS_UPDATE_COMPANY_LICENSE, params)
									.done(function (results, status) {
									
										// on Success show success details
										if (results.response.type === 'SUCCESS') {
											var elements = $('#confirm-info').find('input[data-field]');

											$.each(elements, function (idx, elem) {
												var input = $(elem),
												inputValue = input.val(),
												inputField = input.attr('data-field');
												if (inputField === 'license_status') 
													$('#success-info td[data-cell="license_status"]').text('Active');
												else
													$('#success-info td[data-cell="' + inputField + '"]').text(inputValue);
											});
																				
											$('#step2').removeClass('in');				
											$('#step2').removeClass('active');
											$('a[href="#step2"]').parent().removeClass('active');
											
											$('#step3').addClass('in');				
											$('#step3').addClass('active');
											$('a[href="#step3"]').parent().addClass('active');
										
										// on Failed show WS Error
										} else {
											BootstrapDialog.alert({
												type: 'type-danger',
												title: MSG_TITLE_INFO,
												message: MSG_INFO_WS_ERROR,
												callback: function (result) {
													BootstrapDialog.closeAll();
												}
											});
										}
									});

							// on Failed show error to Client Activation page
							} else {
								BootstrapDialog.alert({
									type: 'type-danger',
									title: MSG_TITLE_INFO,
									message: MSG_INFO_INVALID_LICENSE_KEY,
									callback: function (result) {
										BootstrapDialog.closeAll();
										window.location = DEFAULT_ROOT + 'activation.html';
									}
								});
							}
						});

				});
				
				// Get Started
				$('#get-started').on('click', function () {						
					window.location = DEFAULT_ROOT;
				});
			});
		</script>
	</body>
</html>