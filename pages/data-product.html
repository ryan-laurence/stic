<input type="hidden" id="selected_cust_id">
<div class="panel panel-primary">
	<div class="panel-heading">
		<i class="fa fa-pencil-square-o"></i> Product Data
	</div>
	<div class="panel-body">
		<div class="panel panel-default" style="margin-bottom: 5px">
			<div class="panel-heading">
				<i class="fa fa-users"></i> <strong>Customers Data</strong>
			</div>
			<div class="panel-body">
				<table class="display compact" id="table-customer">
					<thead>
						<tr>
							<th class="text-left">Customer ID</th>
							<th class="text-left">Customer Code</th>
							<th class="text-left">Customer Name</th>
						</tr>
					</thead>
					<tbody>
					</tbody>
				</table>
			</div>
		</div>
		<div class="panel panel-default" style="margin-bottom: 5px">
			<div class="panel-heading" id="panel-title-destinations">
				<i class="fa fa-map-marker"></i> <strong>Destination Data</strong>
			</div>
			<div class="panel-body" id="panel-content-destinations">
				<table class="display compact" id="table-destination">
					<thead>
						<tr>
							<th class="text-left">CD ID</th>
							<th class="text-left">Customer ID</th>
							<th class="text-left">Destination ID</th>
							<th class="text-left">Zip Code</th>
							<th class="text-left">Name</th>
							<th class="text-left">Location</th>
						</tr>
					</thead>
					<tbody>
					</tbody>
				</table>
			</div>
		</div>
		<div class="panel panel-default" style="margin-bottom: 10px">
			<div class="panel-heading" id="panel-title-products">
				<i class="fa fa-product-hunt"></i> <strong>Product Data</strong>
			</div>
			<div class="panel-body">
				<div class="btn-toolbar" role="toolbar" aria-label="Toolbar with button groups">
					<div class="btn-group" role="group" aria-label="First group">
						<button type="button" class="btn btn-primary disabled" id="tools-add-product">Add</button>
					</div>
					<div class="btn-group" role="group" aria-label="Second group">
						<button type="button" class="btn btn-danger disabled" id="tools-remove-product">Remove</button>
					</div>
				</div>
				<table class="display compact" id="table-product">
					<thead>
						<tr>
							<th class="text-left">CP ID</th>
							<th class="text-left">Customer ID</th>
							<th class="text-left">Product ID</th>
							<th class="text-left">Product Code</th>
							<th class="text-left">Product Name</th>
							<th class="text-left">Unit Price</th>
						</tr>
					</thead>
					<tbody>
					</tbody>
				</table>
			</div>
		</div>
	</div>
</div>
<div class="modal fade bootstrap-dialog type-primary" id="destination-modal" tabindex="-1" role="dialog" aria-labelledby="destinationModal" aria-hidden="true">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="bootstrap-dialog-title"><i class="fa fa-map-marker"></i> Select Destination</h4>
			</div>
			<div class="modal-body">
				<table class="display compact" id="table-destination-picker" style="width: 100%">
					<thead>
						<tr>
							<th class="text-left">Destination ID</th>
							<th class="text-left">Zip Code</th>
							<th class="text-left">Name</th>
							<th class="text-left">Location</th>
						</tr>
					</thead>
					<tbody>
					</tbody>
				</table>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-primary disabled" id="select-item"><i class="fa fa-floppy-o"></i> Pick Selected</button>
				<button type="button" class="btn btn-default" data-dismiss="modal"><i class="fa fa-ban"></i> Close</button>
			</div>
		</div>
	</div>
</div>
<div class="modal fade" id="product-modal" tabindex="-1" role="dialog" aria-labelledby="productModal" aria-hidden="true">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title">Select Product</h4>
			</div>
			<div class="modal-body">
				<table class="display compact" id="table-product-picker">
					<thead>
						<tr>
							<th class="text-left">Product ID</th>
							<th class="text-left">Product Code</th>
							<th class="text-left">Product Name</th>
							<th class="text-left">Unit Price</th>
						</tr>
					</thead>
					<tbody>
					</tbody>
				</table>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-primary disabled" id="select-item">Pick Selected</button>
				<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
			</div>
		</div>
	</div>
</div>
<script type="text/javascript" src="js/stic-data-custom.js"></script>
<script>
	$(function() {	
		//var customer_data_holder = 'custInfo';
		//var customer_fields = [ 'cust_id', 'cust_code', 'cust_name' ];

		var customer_products_tools = ['tools-remove-product'];
		//var customer_destinations_tools = ['tools-remove-destination'];
		//var customer_tools = ['tools-edit', 'tools-delete', 'tools-add-destination', 'tools-add-product'];
		
		// Trigger on Add Dest Modal OnShown
		/*function btnAddDestOnShown(dialogRef) {
			var modalBody = dialogRef.getModalBody();
			var customer_id = dtCust.row('.selected').data().cust_id;
			var ws_url = WS_DESTINATION_LIST + customer_id;
			var t_destination_picker = _fnSetDataTable('table-destination-picker', ws_url, DS_DESTINATION_LIST, CD_DESTINATION_LIST, 10);
			
			$('#table-destination-picker tbody').on( 'click', 'tr', function () {
				if ($(this).hasClass('selected')) {		
					$(this).removeClass('selected');	
				} else {
					dtCust.$('tr.selected').removeClass('selected');
					$(this).addClass('selected');				
					// enable modal button
				}	
			});			
		}*/
		
		// Trigger on Add Prod Modal OnShown
		function btnAddProdOnShown(dialogRef) {
			var modalBody = dialogRef.getModalBody();
		}
		
		// Add Dest Action
		function btnAddDestAction(dialogRef) {
			
		}
		
		// Remove Dest Action
		function btnDelDestAction(e, dt, node, config) {
			BootstrapDialog.confirm({
				title: MSG_TITLE_CONFIRM_DELETE,
				message: MSG_CONFIRM_DELETE_RECORD,
				type: BootstrapDialog.TYPE_DANGER,
				callback: function(result) {
					if (result) {
						var pkIdVal = dt.cell('.selected', 0).data(),
							postData = $.parseJSON('{"custDestId":"' + pkIdVal + '"}');
						$.ajax({
							method: 'POST',
							url: WS_CUSTDEST_DELETE,
							data: postData
						}).done(function(a) {
							dt.ajax.reload();
							dt.button('delDest:name').disable();
							BootstrapDialog.alert({
								title: MSG_INFO_TITLE,
								message: MSG_DEL_REC_INFO,
								type: BootstrapDialog.TYPE_PRIMARY,
								callback: function() {
									BootstrapDialog.closeAll();
								}
							});
						}).fail(function() {
							dt.ajax.reload();
							dt.button('delDest:name').disable();
							BootstrapDialog.alert({
								title: MSG_WS_ERROR_TITLE,
								message: MSG_WS_ERROR_INFO,
								type: BootstrapDialog.TYPE_DANGER,
								callback: function() {
									BootstrapDialog.closeAll();
								}
							});
						});
					} else {
						dt.ajax.reload();
						dt.button('delDest:name').disable();
					}
				}
			});
		}
		
		// Panel Options
		var destPanelTitle = '<i class="fa fa-map-marker"></i> <strong>Destination Data</strong>',
			prodPanelTitle = '<i class="fa fa-product-hunt"></i> <strong>Product Data</strong>';
			
		// Modal Options
		var modalDestContent = $('<div></div>').load( DEFAULT_ROOT + 'pages/data-destination-form.html'),
			//modalProdContent = $('<div></div>').load(''),
			modalDestTitle = '<i class="fa fa-map-marker"></i> Select Destination',
			modalProdTitle = '<i class="fa fa-product-hunt"></i> Select Product';
			
		// DT Buttons Text
		var dtBtnAddTxt = '<i class="fa fa-plus"></i> Add',
			dtBtnDelTxt = '<i class="fa fa-trash-o"></i> Delete';
			
		// Modal Buttons Object
		var modalBtnAddDest = {
				label: 'Pick Selected',
				cssClass: 'btn-primary',
				icon: 'fa fa-floppy-o',
				action: btnAddDestAction
			},
			modalBtnCancelDest = {
				label: 'Cancel',
				icon: 'fa fa-ban',
				action: function(dialogItself) {
					BootstrapDialog.closeAll();
					dtCustDest.button('delDest:name').disable();
				}
			};
			
		// DT Buttons Object
		var dtBtnAddDest = {
				name: 'addDest',
				text: dtBtnAddTxt,
				action: function(e, dt, node, config) {
					/*BootstrapDialog.show({
						closable: false,
						title: modalDestTitle,
						message: modalDestContent,
						onshown: btnAddDestOnShown,
						buttons: [modalBtnAddDest, modalBtnCancelDest]
					});*/
					var customer_id = dtCust.row('.selected').data().cust_id;
					var ws_url = WS_DESTINATION_LIST + customer_id;
					t_destination_picker.destroy();
					t_destination_picker = _fnSetDataTable('table-destination-picker', ws_url, DS_DESTINATION_LIST, CD_DESTINATION_LIST, 10);
					
					$('#table-destination-picker tbody').on( 'click', 'tr', function () {
						if ($(this).hasClass('selected')) {		
							$(this).removeClass('selected');	
							$('#destination-modal #select-item').addClass('disabled');
						} else {
							t_destination_picker.$('tr.selected').removeClass('selected');
							$(this).addClass('selected');				
							$('#destination-modal #select-item').removeClass('disabled');
						}	
					});			
					$('#destination-modal').modal('show');
				}
			},
			dtBtnDelDest = {
				name: 'delDest',
				enabled: false,
				text: dtBtnDelTxt,
				action: btnDelDestAction
			};

		// Customer DT
		var dtCust = loadCustomerData({
			pk_id: 'cust_id',
			root_node: 'custInfo',
			report_title: 'Customer Data',
			frm_html: FORM_CUSTOMER_DATA,
			dt_cd: CD_CUSTOMER_LIST,
			dt_ds: DS_CUSTOMER_LIST,
			ws_list: WS_CUSTOMER_LIST,
			ws_insert: WS_CUSTOMER_INSERT,
			ws_update: WS_CUSTOMER_UPDATE,
			ws_delete: WS_CUSTOMER_DELETE
		});
		
		// Destination DT
		var dtCustDest = $('#table-destination')
			.DataTable({
				ordering: false,
				searching: false,
				processing: true,
				lengthChange: false,
				dom: '<"dt-toolbar">Brtip',
				pageLength: 5,
				columns: CD_CUSTDEST_LIST,
				ajax: { url: DEFAULT_ROOT + 'data/data-destination-empty.json', dataSrc: DS_CUSTDEST_LIST },
				buttons: [dtBtnAddDest, dtBtnDelDest]
			});
			
		// Product DT
		var dtCustProd = $('#table-product')
			.DataTable({
				ordering: false,
				searching: false,
				processing: true,
				lengthChange: false,
				dom: '<"dt-toolbar">rtip',
				pageLength: 5,
				columns: CD_CUSTPROD_LIST,
				ajax: { url: WS_CUSTPROD_LIST, dataSrc: DS_CUSTPROD_LIST }
				//buttons: [dtBtnAddProd, dtBtnDelProd]
			});
			
		var t_product_picker = $('#table-product-picker').DataTable();
		var t_destination_picker = $('#table-destination-picker').DataTable();

		// Customer DT Row Click Event
		$('#table-customer tbody').on('click', 'tr', function() {
			var customer_id = dtCust.row(this).data().cust_id,
				customer_code = dtCust.row(this).data().cust_code,
				customer_name = dtCust.row(this).data().cust_name,
				customer_destinations_url = WS_CUSTDEST_LIST + '&cust_id=' + customer_id,
				customer_products_url = WS_CUSTPROD_LIST + '&cust_id=' + customer_id;
			if ($(this).hasClass('selected')) {		
				$(this).removeClass('selected');	
				dtCust.button('edit:name').disable();
				dtCust.button('delete:name').disable();	
				dtCustProd.clear().draw();
				dtCustDest.clear().draw();
				$('#panel-title-destinations').html(destPanelTitle);
				$('#panel-title-products').html(prodPanelTitle);		
			} else {
				dtCust.$('tr.selected').removeClass('selected');
				$(this).addClass('selected');				
				dtCust.button('edit:name').enable();
				dtCust.button('delete:name').enable();	
				dtCustProd.ajax.url(customer_products_url).load();
				dtCustDest.ajax.url(customer_destinations_url).load();
				$('#panel-title-destinations').html(destPanelTitle + ' > ' + customer_code + ' ' + customer_name);
				$('#panel-title-products').html(prodPanelTitle + ' > ' + customer_code + ' ' + customer_name);
			}		
		});
		
		// Destination DT Row Click Event
		$('#table-destination tbody').on('click', 'tr', function() {
			if (dtCustDest.row(this).data().cd_id != '') {
				if ($(this).hasClass('selected')) {		
					$(this).removeClass('selected');	
					dtCustDest.button('delDest:name').disable();		
				} else {
					dtCust.$('tr.selected').removeClass('selected');
					$(this).addClass('selected');				
					dtCustDest.button('delDest:name').enable();	
				}		
			}
		});
		
		
		
		
		
		
		
	

		// Destination > Tools > Add > Insert Destination
		$('#destination-modal #select-item').on('click', function() {
			var customer_id = t_customer.row('.selected').data().cust_id;
			var destination_id = t_destination_picker.row('.selected').data().dest_id;
			var post_data = 'custDestInfo={ "cust_id": ' + customer_id + ', "dest_id": ' + destination_id + '}';
			$.post(WS_CUSTDEST_INSERT, post_data, function(data, status) {
				dtCustDest.ajax.reload();
				$('#destination-modal').modal('hide');
			});
		});

		// Destination > Tools > Remove
		$('#tools-remove-destination').on('click', function() {
			var cd_id = dtCustDest.row('.selected').data().cd_id;
			var post_url = WS_CUSTDEST_DELETE + 'custDestId=' + cd_id;
			$.ajax({
				method: "GET",
				url: post_url,
			}).done(function(msg) {
				dtCustDest.row('.selected').remove().draw( false );
				dtCustDest.ajax.reload();
			});
		});
		
		
		







		

		// Product > Data Table > Row Click Event
		$('#table-product tbody').on( 'click', 'tr', function () {
			if (dtCustProd.row(this).data().cp_id != '') {
				_fnTableRowSelection(dtCustProd, this, customer_products_tools);
			}
		});


		

		

		

		// Product > Tools > Add
		$('#tools-add-product').on('click', function() {
			// Data Table
			//t_product_picker.clear();
			t_product_picker.destroy();
			t_product_picker = _fnSetDataTable('table-product-picker', WS_PRODUCT_LIST, DS_PRODUCT_LIST, CD_PRODUCT_LIST, 10);

			// Show
			$('#product-modal').modal('show');
		});

		// Product > Tools > Add > Row Click Event
		$('#table-product-picker tbody').on( 'click', 'tr', function () {
			_fnTableRowSelection(t_product_picker, this, ['product-modal #select-item']);
		});

		// Product > Tools > Add > Insert Product
		$('#product-modal #select-item').on('click', function() {
			var customer_id = t_customer.row('.selected').data().cust_id;
			var product_id = t_product_picker.row('.selected').data().prod_id;
			var post_data = 'custProdInfo={ "cust_id": ' + customer_id + ', "prod_id": ' + product_id + '}';
			$.post(WS_CUSTPROD_INSERT, post_data, function(data, status) {
				dtCustProd.ajax.reload();
				$('#product-modal').modal('hide');
			});
		});

		// Product > Tools > Remove
		$('#tools-remove-product').on('click', function() {
			var cp_id = dtCustProd.row('.selected').data().cp_id;
			var post_url = WS_CUSTPROD_DELETE + 'custProdId=' + cp_id;
			$.ajax({
				method: "GET",
				url: post_url,
			}).done(function(msg) {
				dtCustProd.row('.selected').remove().draw( false );
				dtCustProd.ajax.reload();
			});
		});
	});
</script>